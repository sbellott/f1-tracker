generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                  String        @id @default(cuid())
  email               String        @unique
  emailVerified       DateTime?
  password            String?
  pseudo              String?
  avatar              String?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  notifyBeforeSession Boolean       @default(true)
  notifyDelayMinutes  Int           @default(30)
  darkMode            Boolean       @default(true)
  accounts            Account[]
  groups              GroupMember[]
  createdGroups       Group[]       @relation("GroupCreator")
  predictions         Prediction[]
  sessions            Session[]
  badges              UserBadge[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Group {
  id          String        @id @default(cuid())
  name        String
  inviteCode  String        @unique @default(cuid())
  createdById String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  members     GroupMember[]
  createdBy   User          @relation("GroupCreator", fields: [createdById], references: [id])
  predictions Prediction[]

  @@map("groups")
}

model GroupMember {
  id          String   @id @default(cuid())
  userId      String
  groupId     String
  joinedAt    DateTime @default(now())
  totalPoints Int      @default(0)
  group       Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId])
  @@map("group_members")
}

model Prediction {
  id              String      @id @default(cuid())
  userId          String
  groupId         String
  raceId          String
  sessionType     SessionType @default(RACE)
  topTen          Json
  polePosition    String?
  fastestLap      String?
  points          Int?
  pointsBreakdown Json?
  createdAt       DateTime    @default(now())
  lockedAt        DateTime?
  group           Group       @relation(fields: [groupId], references: [id], onDelete: Cascade)
  race            Race        @relation(fields: [raceId], references: [id])
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId, raceId, sessionType])
  @@map("predictions")
}

model Race {
  id           String        @id @default(cuid())
  season       Int
  round        Int
  name         String
  officialName String?
  circuitId    String
  date         DateTime
  hasSprint    Boolean       @default(false)
  resultsJson  Json?
  predictions  Prediction[]
  sessions     RaceSession[]
  circuit      Circuit       @relation(fields: [circuitId], references: [id])

  @@unique([season, round])
  @@map("races")
}

model RaceSession {
  id               String      @id @default(cuid())
  raceId           String
  type             SessionType
  dateTime         DateTime
  completed        Boolean     @default(false)
  canalPlusChannel String?
  isLive           Boolean     @default(true)
  resultsJson      Json?
  race             Race        @relation(fields: [raceId], references: [id], onDelete: Cascade)

  @@unique([raceId, type])
  @@map("race_sessions")
}

model Circuit {
  id              String           @id @default(cuid())
  ergastId        String           @unique
  name            String
  officialName    String?
  country         String
  city            String
  length          Float?
  turns           Int?
  lapRecord       String?
  lapRecordHolder String?
  lapRecordYear   Int?
  direction       String?
  firstGP         Int?
  drsZones        Int?
  trackImageUrl   String?
  facts           String?
  history         String?
  results         CircuitHistory[]
  races           Race[]

  @@map("circuits")
}

model CircuitHistory {
  id           String  @id @default(cuid())
  circuitId    String
  season       Int
  winnerId     String?
  poleId       String?
  fastestLapId String?
  winnerTime   String?
  circuit      Circuit @relation(fields: [circuitId], references: [id])
  fastestLap   Driver? @relation("CircuitFastestLap", fields: [fastestLapId], references: [id])
  pole         Driver? @relation("CircuitPole", fields: [poleId], references: [id])
  winner       Driver? @relation("CircuitWinner", fields: [winnerId], references: [id])

  @@unique([circuitId, season])
  @@map("circuit_history")
}

model Driver {
  id                 String           @id @default(cuid())
  ergastId           String           @unique
  code               String
  number             Int?
  firstName          String
  lastName           String
  nationality        String
  dateOfBirth        DateTime?
  photoUrl           String?
  constructorId      String?
  totalRaces         Int              @default(0)
  totalWins          Int              @default(0)
  totalPodiums       Int              @default(0)
  totalPoles         Int              @default(0)
  totalFastestLaps   Int              @default(0)
  totalPoints        Float            @default(0)
  championships      Int              @default(0)
  circuitFastestLaps CircuitHistory[] @relation("CircuitFastestLap")
  circuitPoles       CircuitHistory[] @relation("CircuitPole")
  circuitWins        CircuitHistory[] @relation("CircuitWinner")
  constructor        Constructor?     @relation(fields: [constructorId], references: [id])
  standings          Standing[]

  @@map("drivers")
}

model Constructor {
  id                String     @id @default(cuid())
  ergastId          String     @unique
  name              String
  shortName         String?
  nationality       String
  base              String?
  teamPrincipal     String?
  technicalDirector String?
  engine            String?
  color             String?
  logoUrl           String?
  totalWins         Int        @default(0)
  totalPodiums      Int        @default(0)
  totalPoles        Int        @default(0)
  championships     Int        @default(0)
  firstSeason       Int?
  drivers           Driver[]
  standings         Standing[]

  @@map("constructors")
}

model Standing {
  id            String       @id @default(cuid())
  season        Int
  round         Int
  type          StandingType
  position      Int
  driverId      String?
  constructorId String?
  points        Float
  wins          Int          @default(0)
  constructor   Constructor? @relation(fields: [constructorId], references: [id])
  driver        Driver?      @relation(fields: [driverId], references: [id])

  @@unique([season, round, type, driverId])
  @@unique([season, round, type, constructorId])
  @@map("standings")
}

model Badge {
  id          String      @id @default(cuid())
  code        String      @unique
  name        String
  description String
  icon        String
  condition   String
  users       UserBadge[]

  @@map("badges")
}

model UserBadge {
  id         String   @id @default(cuid())
  userId     String
  badgeId    String
  unlockedAt DateTime @default(now())
  raceId     String?
  badge      Badge    @relation(fields: [badgeId], references: [id])
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@map("user_badges")
}

model NewsItem {
  id          String   @id @default(cuid())
  externalId  String   @unique
  source      String
  title       String
  summary     String?
  imageUrl    String?
  url         String
  publishedAt DateTime
  category    String?
  fetchedAt   DateTime @default(now())

  @@index([publishedAt])
  @@map("news_items")
}

enum SessionType {
  FP1
  FP2
  FP3
  SPRINT_QUALIFYING
  SPRINT
  QUALIFYING
  RACE
}

enum StandingType {
  DRIVER
  CONSTRUCTOR
}
